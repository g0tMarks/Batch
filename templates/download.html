<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BATCH - Download Template</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <nav class="navbar">
        <a href="{{ url_for('index') }}" class="batch-link">BATCH</a>
        <div class="nav-buttons">
            {% if session.user %}
                <a href="{{ url_for('download_template') }}" class="nav-btn{% if request.endpoint == 'download_template' %} active{% endif %}">DOWNLOAD</a>
                <a href="{{ url_for('upload_page') }}" class="nav-btn{% if request.endpoint == 'upload_page' %} active{% endif %}">UPLOAD</a>
                <a href="{{ url_for('view_reports') }}" class="nav-btn{% if request.endpoint == 'view_reports' %} active{% endif %}">REPORTS</a>
                <a href="{{ url_for('logout') }}" class="nav-btn">LOGOUT</a>
            {% else %}
                <a href="{{ url_for('login') }}" class="nav-btn{% if request.endpoint == 'login' %} active{% endif %}">LOGIN</a>
                <a href="{{ url_for('signup') }}" class="nav-btn{% if request.endpoint == 'signup' %} active{% endif %}">SIGN UP</a>
            {% endif %}
        </div>
    </nav>
    <div class="download-card">
        <div class="download-title">Download Template</div>
        <div class="download-subtitle">Get started by downloading the Excel template for your student data</div>
        
        <div class="instructions-section">
            <div class="instructions-title">How to use the template:</div>
            <ol class="instructions-list">
                <li><strong>Download</strong> the Excel template using the button below.</li>
                <li><strong>Fill in student data</strong> including additional comments.</li>
                <li><strong>Include sample reports</strong> you've written in the past for each student, to help the LLM understand your writing style. The AI Model will follow the exact tone, structure and content in each sample report.</li>
                <li><strong>Save the file</strong> and upload it using the Upload page.</li>
                <li><strong>Generate reports</strong> and let Batch create personalised reports for all your students.</li>
            </ol>
        <div class="testing-section"></div>
            <div class="testing-title"><strong>Please note:</strong></div>
                <div class="testing-subtitle">This tool is in the testing phase, and report generation might be delayed. If you encounter any errors, please contact support.</div>
        </div>
        
        <button id="downloadButton" class="download-button" onclick="downloadTemplate()">
            <img src="{{ url_for('static', filename='icons/download.svg') }}" alt="Download" style="width: 1.3em; height: 1.3em;">
            Download Excel Template
        </button>
        
        <div id="statusMessage" class="status-message"></div>
        
        <div class="next-steps">
            <div class="next-steps-text">Once you've filled in the template, upload it to generate your reports:</div>
            <a href="{{ url_for('upload_page') }}" class="upload-link">
                <img src="{{ url_for('static', filename='icons/upload.svg') }}" alt="Upload" style="width: 1.1em; height: 1.1em;">
                Go to Upload
            </a>
        </div>
    </div>

    <script>
        function downloadTemplate() {
            const button = document.getElementById('downloadButton');
            const statusMessage = document.getElementById('statusMessage');
            
            // Disable button and show loading state
            button.disabled = true;
            button.innerHTML = `
                <span style="display: inline-block; width: 1.3em; height: 1.3em; margin-right: 0.7rem;">
                    <div style="border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; width: 1.3em; height: 1.3em; animation: spin 1s linear infinite;"></div>
                </span>
                Downloading...
            `;
            
            // Hide any previous status messages
            statusMessage.style.display = 'none';
            statusMessage.className = 'status-message';
            
            // Make the download request
            fetch('/download-template-file', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.blob();
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'template_student_data.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Show success message
                statusMessage.textContent = 'Template downloaded successfully!';
                statusMessage.className = 'status-message success';
                statusMessage.style.display = 'block';
                
                // Reset button
                resetButton();
            })
            .catch(error => {
                console.error('Download error:', error);
                
                // Show error message
                statusMessage.textContent = 'Failed to download template. Please try again.';
                statusMessage.className = 'status-message error';
                statusMessage.style.display = 'block';
                
                // Reset button
                resetButton();
            });
        }
        
        function resetButton() {
            const button = document.getElementById('downloadButton');
            button.disabled = false;
            button.innerHTML = `
                <img src="{{ url_for('static', filename='icons/download.svg') }}" alt="Download" style="width: 1.3em; height: 1.3em; filter: brightness(0) invert(1);">
                Download Excel Template
            `;
        }
        
        // Add CSS for loading spinner
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
